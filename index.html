<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Raport FS25</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            margin-bottom: 1.5rem;
            padding: 0.5rem 1rem;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            display: block;
        }
        .chart-container.flex { display:flex; align-items:center; justify-content:center; }
        .dark .chart-container { background-color: #111827 }
        canvas { width: 100%; height: 100%; display: block; }
        .table-header { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <nav class="bg-blue-600 dark:bg-blue-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Raport FS25</h1>
            <div class="space-x-4">
                <a href="#summary" class="text-white hover:underline">Podsumowanie</a>
                <a href="#charts" class="text-white hover:underline">Wykresy</a>
                <a href="#errors" class="text-white hover:underline">Błędy</a>
                <a href="#warnings" class="text-white hover:underline">Ostrzeżenia</a>
                <a href="#sessions" class="text-white hover:underline">Sesje Graczy</a>
                <a href="#admin" class="text-white hover:underline">Akcje Admina</a>
                <a href="#mods" class="text-white hover:underline">Mody</a>
                <a href="#mod-issues" class="text-white hover:underline">Problemy z modami</a>
                <button id="theme-toggle" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Przełącz motyw</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <p class="mb-6">Wygenerowano: 2025-10-14 13:24:43</p>

        <!-- Podsumowanie -->
        <section id="summary" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Podsumowanie</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Liczba zdarzeń</h3>
                    <p class="text-2xl">1642012</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Błędy</h3>
                    <p class="text-2xl">170007</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Ostrzeżenia</h3>
                    <p class="text-2xl">43771</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Mody</h3>
                    <p class="text-2xl">10334</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">DLC</h3>
                    <p class="text-2xl">75</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Sesje graczy</h3>
                    <p class="text-2xl">74</p>
                </div>
            </div>
        </section>

        <!-- Wykresy -->
        <section id="charts" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Wykresy</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="other_charts" class="chart-container"></div>
                <div id="save_charts" class="chart-container"></div>
                <div id="warning_charts" class="chart-container"></div>
                <div id="sessions_charts" class="chart-container"></div>
                <div id="admin_charts" class="chart-container"></div>
                <div id="mod_issues" class="chart-container"></div>
            </div>
        </section>

        <!-- Błędy -->
        <section id="errors" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Błędy</h2>
            <div id="errors_section"></div>
        </section>

        <!-- Ostrzeżenia -->
        <section id="warnings" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Ostrzeżenia</h2>
            <div id="warnings_section"></div>
        </section>

        <!-- Sesje -->
        <section id="sessions" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Sesje graczy</h2>
            <div id="sessions_section"></div>
        </section>

        <!-- Admin -->
        <section id="admin" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Akcje admina</h2>
            <div id="admin_section"></div>
        </section>

        <!-- Mody -->
        <section id="mods" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Mody</h2>
            <div id="mods_section"></div>
        </section>

        <!-- Problemy z modami -->
        <section id="mod-issues" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Problemy z modami</h2>
            <div id="mod_issues_section"></div>
        </section>

        <footer class="text-center text-gray-600 dark:text-gray-400">
            <p>Wygenerowano przez logs_analyzer.py</p>
        </footer>
    </div>

    <script>
        
document.addEventListener('DOMContentLoaded', async () => {
  function mkEl(tag, cls, txt) { const e = document.createElement(tag); if (cls) e.className = cls; if (txt!==undefined) e.textContent = txt; return e; }
  const dbg = mkEl('div', 'debug-panel p-4 bg-white dark:bg-gray-800 text-sm rounded shadow mb-4');
  dbg.style.maxHeight='45vh'; dbg.style.overflow='auto';
  dbg.appendChild(mkEl('h3','text-lg font-semibold mb-2','DEBUG: data_index.json + parts loader'));
  const container = document.querySelector('.container') || document.body;
  container.prepend(dbg);
  function log(msg, lvl='log') { const r=mkEl('div','debug-row'); r.style.borderBottom='1px solid rgba(0,0,0,0.06)'; r.style.padding='6px 0'; r.innerHTML=`<strong>[${(new Date()).toLocaleTimeString()}]</strong> ${msg}`; dbg.appendChild(r); if(lvl==='error') console.error(msg); else if(lvl==='warn') console.warn(msg); else console.log(msg); }
  async function fetchJson(url) { try { const r = await fetch(url); const txt = await r.text(); try { const j = JSON.parse(txt); return {ok:r.ok, status:r.status, json:j}; } catch(e){ return {ok:r.ok, status:r.status, text:txt}; } } catch(e){ return {ok:false, status:'NETWORK', err:e}; } }

  // candidate data_index.json locations (relative to index.html and common repo folders)
  const candidates = [
    'data_index.json','./data_index.json',
    'reports/FS25Logs/data_index.json','./reports/FS25Logs/data_index.json',
    'reports/data_index.json','./reports/data_index.json',
    'FS25Logs/data_index.json','./FS25Logs/data_index.json',
    'data/data_index.json','./data/data_index.json'
  ];

  // also compose raw.githubusercontent URL possibility if served via github pages from a repo
  function asRawGithub(url) {
    try {
      const u = new URL(url);
      // only transform if host includes github.io or raw.githubusercontent not already
      if (u.hostname.endsWith('github.io') || u.hostname === location.hostname) {
        // try derive repo path from pathname: /owner/repo/... -> raw.githubusercontent.com/owner/repo/HEAD/...
        const parts = u.pathname.split('/').filter(Boolean);
        if (parts.length >= 2) {
          const owner = parts[0], repo = parts[1];
          // try file path after owner/repo
          const filePath = parts.slice(2).join('/');
          if (filePath) return `https://raw.githubusercontent.com/${owner}/${repo}/HEAD/${filePath}`;
        }
      }
    } catch(e){}
    return null;
  }

  let index = null, indexUrl = null;
  for (const p of candidates) {
    const url = new URL(p, location.href).href;
    log('Checking index at: ' + url);
    const res = await fetchJson(url);
    if (res.ok && res.json) { index = res.json; indexUrl = url; log('✅ Loaded index from ' + url); break; }
    log(`✖ result for ${url}: status=${res.status}`,'warn');
    // try raw.github alternative
    const raw = asRawGithub(url);
    if (raw) {
      log('Trying raw github url: ' + raw);
      const r2 = await fetchJson(raw);
      if (r2.ok && r2.json) { index = r2.json; indexUrl = raw; log('✅ Loaded index from raw github ' + raw); break; }
      log(`✖ raw github ${raw}: status=${r2.status}`,'warn');
    }
  }

  if (!index) { log('❌ data_index.json not found in any candidate path. Ensure it is committed and published.', 'error'); return; }

  // show top-level keys and a few fields
  try { log('Index keys: ' + JSON.stringify(Object.keys(index).slice(0,30))); } catch(e){ log('Cannot stringify index keys','warn'); }

  const parts = (index.tables_index && Array.isArray(index.tables_index.parts)) ? index.tables_index.parts : [];
  log('Declared parts count: ' + parts.length);

  // data skeleton
  const data = { charts: index.charts||{}, summaries: index.summaries||{}, meta: index.meta||{}, raw_event_counts: index.raw_event_counts||{}, tables: {errors:[], warnings:[], sessions:[], admin:[], mods:[]} };

  // helper to try variations of part path
  function variantsFor(partFile) {
    const vars = [];
    try {
      // as-is relative to indexUrl
      const v1 = new URL(partFile, indexUrl || location.href).href; vars.push(v1);
      // relative to location (index.html)
      const v2 = new URL(partFile, location.href).href; if (v2 !== v1) vars.push(v2);
      // if partFile already contains 'reports/' try without reports prefix
      if (partFile.startsWith('reports/')) { vars.push(new URL(partFile.replace(/^reports\//,''), indexUrl || location.href).href); }
      // try prefixing with repo root path inferred from location.pathname (useful on github pages subpath)
      const base = location.pathname.replace(/\/[^/]*$/, '/'); // parent path
      try { vars.push(new URL(partFile, location.origin + base).href); } catch(e){}
      // raw github transformation
      const raw = asRawGithub(new URL(partFile, indexUrl || location.href).href);
      if (raw) vars.push(raw);
    } catch(e){}
    // unique
    return Array.from(new Set(vars));
  }

  const loaded = {};
  for (let i=0;i<parts.length;i++){
    const p = parts[i];
    if (!p || !p.file) { log(`Skipping malformed part #${i}: ${JSON.stringify(p)}`,'warn'); continue; }
    const tryList = variantsFor(p.file);
    log(`Part #${i} declared file: ${p.file}; trying variants (${tryList.length})`);
    let ok=false;
    for (const u of tryList) {
      log(' -> try: ' + u);
      const r = await fetchJson(u);
      if (!r.ok) { log(`    ✖ ${u} status=${r.status}`,'warn'); continue; }
      if (!Array.isArray(r.json)) { log(`    ✖ ${u} returned non-array JSON (type ${typeof r.json})`,'warn'); continue; }
      // merge records
      for (const rec of r.json) {
        if (!rec || !rec.table || typeof rec.row !== 'object') continue;
        if (!data.tables[rec.table]) data.tables[rec.table]=[];
        data.tables[rec.table].push(rec.row);
      }
      loaded[u] = r.json.length;
      log(`    ✅ Loaded ${r.json.length} records from ${u}`);
      ok=true; break;
    }
    if (!ok) log(`Part #${i} failed for all variants`, 'error');
  }

  log('--- Loaded parts summary ---');
  try { log(JSON.stringify(loaded)); } catch(e){ log('Cannot stringify loaded summary','warn'); }

  // quick DOM rendering for counts
  try {
    const summaryDiv = mkEl('div','mt-3 p-3 bg-gray-50 dark:bg-gray-900 rounded','');
    const tableCounts = Object.fromEntries(Object.entries(data.tables).map(([k,v])=>[k, (v||[]).length]));
    summaryDiv.innerHTML = `<strong>Tables loaded counts:</strong> ${JSON.stringify(tableCounts)}`;
    dbg.appendChild(summaryDiv);
  } catch(e){ log('DOM summary render failed','warn'); }

  // If no records loaded, show guidance
  const totalLoaded = Object.values(Object.fromEntries(Object.entries(data.tables).map(([k,v])=>[k,(v||[]).length]))).reduce((a,b)=>a+b,0);
  if (totalLoaded===0) {
    log('❗ No records were loaded from parts. Likely causes: parts paths in index.json are not relative to index.html location OR parts were not published to GitHub Pages. Inspect index.json.parts entries and repo tree.', 'warn');
  } else {
    log(`✅ Total records loaded: ${totalLoaded}`);
  }

  // Expose data to window for interactive debugging in console
  window.__FS25_DEBUG__ = { indexUrl, index, data, loaded };

  // Optionally, if you want to auto-render the errors table (first 100) like before:
  try {
    const errorsSection = document.querySelector('#errors');
    if (errorsSection) {
      const errorsSummary = data.summaries?.errors_summary || [];
      const tbodyRows = errorsSummary.map(r => `<tr><td class="p-2">${r.Message||''}</td><td class="p-2">${r.Count||0}</td></tr>`).join('');
      const detailsRows = (data.tables.errors||[]).slice(0,100).map(row=>`<tr><td class="p-2">${row.Timestamp||''}</td><td class="p-2">${row.EventType||''}</td><td class="p-2">${JSON.stringify(row.Details||{})}</td></tr>`).join('');
      const html = `<table class="w-full bg-white dark:bg-gray-800 rounded shadow mb-4 sortable"><thead><tr class="bg-gray-200 dark:bg-gray-700"><th class="p-2 table-header">Wiadomość</th><th class="p-2 table-header">Liczba</th></tr></thead><tbody>${tbodyRows}</tbody></table><details class="mb-4"><summary class="cursor-pointer text-blue-600 dark:text-blue-400">Pokaż pełne dane błędów (pierwsze 100)</summary><table class="w-full bg-white dark:bg-gray-800 rounded shadow sortable"><thead><tr class="bg-gray-200 dark:bg-gray-700"><th class="p-2 table-header">Timestamp</th><th class="p-2 table-header">Typ zdarzenia</th><th class="p-2 table-header">Szczegóły</th></tr></thead><tbody>${detailsRows}</tbody></table></details>`;
      errorsSection.innerHTML = html;
    }
  } catch(e){ log('Error rendering sample errors table: ' + e,'warn'); }

  log('DEBUG finished. You can inspect window.__FS25_DEBUG__ in console for full objects.');
});


    </script>
</body>
</html>
