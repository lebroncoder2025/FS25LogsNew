<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Raport FS25</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            margin-bottom: 1.5rem;
            padding: 0.5rem 1rem;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.08);
            display: block;
        }
        .chart-container.flex { display:flex; align-items:center; justify-content:center; }
        .dark .chart-container { background-color: #111827 }
        canvas { width: 100%; height: 100%; display: block; }
        .table-header { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <nav class="bg-blue-600 dark:bg-blue-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Raport FS25</h1>
            <div class="space-x-4">
                <a href="#summary" class="text-white hover:underline">Podsumowanie</a>
                <a href="#charts" class="text-white hover:underline">Wykresy</a>
                <a href="#errors" class="text-white hover:underline">Błędy</a>
                <a href="#warnings" class="text-white hover:underline">Ostrzeżenia</a>
                <a href="#sessions" class="text-white hover:underline">Sesje Graczy</a>
                <a href="#admin" class="text-white hover:underline">Akcje Admina</a>
                <a href="#mods" class="text-white hover:underline">Mody</a>
                <a href="#mod-issues" class="text-white hover:underline">Problemy z modami</a>
                <button id="theme-toggle" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Przełącz motyw</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <p class="mb-6">Wygenerowano: 2025-10-14 13:24:43</p>

        <!-- Podsumowanie -->
        <section id="summary" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Podsumowanie</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Liczba zdarzeń</h3>
                    <p class="text-2xl">1642012</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Błędy</h3>
                    <p class="text-2xl">170007</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Ostrzeżenia</h3>
                    <p class="text-2xl">43771</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Mody</h3>
                    <p class="text-2xl">10334</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">DLC</h3>
                    <p class="text-2xl">75</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                    <h3 class="text-lg font-medium">Sesje graczy</h3>
                    <p class="text-2xl">74</p>
                </div>
            </div>
        </section>

        <!-- Wykresy -->
        <section id="charts" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Wykresy</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="other_charts" class="chart-container"></div>
                <div id="save_charts" class="chart-container"></div>
                <div id="warning_charts" class="chart-container"></div>
                <div id="sessions_charts" class="chart-container"></div>
                <div id="admin_charts" class="chart-container"></div>
                <div id="mod_issues" class="chart-container"></div>
            </div>
        </section>

        <!-- Błędy -->
        <section id="errors" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Błędy</h2>
            <div id="errors_section"></div>
        </section>

        <!-- Ostrzeżenia -->
        <section id="warnings" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Ostrzeżenia</h2>
            <div id="warnings_section"></div>
        </section>

        <!-- Sesje -->
        <section id="sessions" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Sesje graczy</h2>
            <div id="sessions_section"></div>
        </section>

        <!-- Admin -->
        <section id="admin" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Akcje admina</h2>
            <div id="admin_section"></div>
        </section>

        <!-- Mody -->
        <section id="mods" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Mody</h2>
            <div id="mods_section"></div>
        </section>

        <!-- Problemy z modami -->
        <section id="mod-issues" class="mb-8 fade-in">
            <h2 class="text-2xl font-semibold mb-4">Problemy z modami</h2>
            <div id="mod_issues_section"></div>
        </section>

        <footer class="text-center text-gray-600 dark:text-gray-400">
            <p>Wygenerowano przez logs_analyzer.py</p>
        </footer>
    </div>

    <script>
        
document.addEventListener('DOMContentLoaded', async () => {
  const toggleButton = document.getElementById('theme-toggle');
  if (toggleButton) {
    toggleButton.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
  }

  // helper: try fetch and return parsed json or null
  async function tryFetchJson(url) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) return null;
      return await resp.json();
    } catch (e) {
      return null;
    }
  }

  // find data_index.json in several possible relative locations
  const candidatePaths = [
    'data_index.json',
    './data_index.json',
    'reports/FS25Logs/data_index.json',
    './reports/FS25Logs/data_index.json',
    'reports/data_index.json',
    './reports/data_index.json',
    'FS25Logs/data_index.json',
    './FS25Logs/data_index.json'
  ];

  let index = null;
  let indexUrl = null;
  for (const p of candidatePaths) {
    const url = new URL(p, location.href).href;
    console.info('Checking data_index at', url);
    const parsed = await tryFetchJson(url);
    if (parsed) {
      index = parsed;
      indexUrl = url;
      console.info('Found data_index.json at', url);
      break;
    } else {
      console.debug('Not found (or invalid JSON) at', url);
    }
  }

  if (!index) {
    console.error('data_index.json not found in any candidate path. Check file placement in the repo.');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'text-center text-red-500 dark:text-red-400 p-4';
    errorDiv.textContent = 'Błąd: Nie znaleziono data_index.json. Sprawdź strukturę plików.';
    const container = document.querySelector('.container');
    if (container) container.prepend(errorDiv);
    return;
  }

  // Prepare data skeleton
  const data = {
    charts: index.charts || {},
    summaries: index.summaries || {},
    meta: index.meta || {},
    raw_event_counts: index.raw_event_counts || {},
    tables: { errors: [], warnings: [], sessions: [], admin: [], mods: [] }
  };

  const parts = (index.tables_index && Array.isArray(index.tables_index.parts)) ? index.tables_index.parts : [];
  console.info('tables_index counts:', index.tables_index && index.tables_index.counts);
  console.info('Number of parts to fetch:', parts.length);

  // fetch each part; allow for parts.file being absolute or relative
  for (const p of parts) {
    if (!p || !p.file) {
      console.warn('Skipping invalid part entry', p);
      continue;
    }
    const partUrl = new URL(p.file, indexUrl || location.href).href;
    try {
      console.debug('Fetching part', partUrl);
      const partResp = await fetch(partUrl);
      if (!partResp.ok) {
        console.error('Failed to fetch part', partUrl, 'status', partResp.status);
        continue;
      }
      const partData = await partResp.json();
      if (!Array.isArray(partData)) {
        console.error('Part is not an array', partUrl);
        continue;
      }
      for (const rec of partData) {
        if (!rec || !rec.table || typeof rec.row !== 'object') {
          console.warn('Skipping malformed record in', partUrl, rec);
          continue;
        }
        if (!data.tables[rec.table]) data.tables[rec.table] = [];
        data.tables[rec.table].push(rec.row);
      }
      console.debug(`Loaded ${partData.length} records from ${partUrl}`);
    } catch (e) {
      console.error('Error fetching/parsing part', partUrl, e);
    }
  }

  // ---- rendering logic (charts + tables) ----
  // minimal defensive rendering: populate simple summaries and first rows where available

  // Update summary counts if available
  try {
    const summarySection = document.querySelector('#summary');
    if (summarySection) {
      const eventsCountEl = summarySection.querySelector('.text-2xl');
      // leave as-is; summary generated server-side. no-op.
    }
  } catch (e) {
    console.warn('Summary render skipped', e);
  }

  // Render charts: reuse existing data.charts structure (if present)
  const styleMap = {
    other_charts:   { title: 'Inne zdarzenia', color: '#3b82f6', bg: 'rgba(59,130,246,0.35)', defaultType: 'bar', horizontal: false },
    save_charts:    { title: 'Zapisy gry (dzień)', color: '#10b981', bg: 'rgba(16,185,129,0.35)', defaultType: 'line', horizontal: false },
    warning_charts: { title: 'Ostrzeżenia (dzień)', color: '#ef4444', bg: 'rgba(239,68,68,0.35)', defaultType: 'line', horizontal: false },
    sessions_charts:{ title: 'Sesje graczy',   color: '#6366f1', bg: 'rgba(99,102,241,0.35)', defaultType: 'bar', horizontal: true },
    admin_charts:   { title: 'Akcje admina',   color: '#14b8a6', bg: 'rgba(20,184,166,0.35)', defaultType: 'bar', horizontal: true },
    mod_issues:     { title: 'Problemy z modami', color: '#8b5cf6', bg: 'rgba(139,92,246,0.35)', defaultType: 'bar', horizontal: true },
  };

  function computeHeight(labels, horizontal) {
    if (!Array.isArray(labels)) return 420;
    const base = horizontal ? 90 : 120;
    const perLabel = horizontal ? 28 : 20;
    const h = base + labels.length * perLabel;
    return Math.max(380, Math.min(1000, h));
  }

  const chartsData = data.charts || {};
  Object.entries({
    other_charts: chartsData.other_charts || {},
    save_charts: chartsData.save_charts || {},
    warning_charts: chartsData.warning_charts || {},
    sessions_charts: chartsData.sessions_charts || {},
    admin_charts: chartsData.admin_charts || {},
    mod_issues: chartsData.mod_issues || {}
  }).forEach(([sectionKey, group]) => {
    const container = document.getElementById(sectionKey);
    const style = styleMap[sectionKey] || { title: sectionKey, color: '#374151', bg: 'rgba(55,65,81,0.3)', defaultType: 'bar', horizontal: false };
    if (!container) return;

    if (!group || Object.keys(group).length === 0) {
      const ph = document.createElement('div');
      ph.className = 'chart-container flex items-center justify-center';
      ph.style.minHeight = '160px';
      ph.innerHTML = `<div class="text-center"><div style="font-weight:600;margin-bottom:6px">${style.title}</div><div style="color:#6b7280">Obecnie brak danych</div></div>`;
      container.appendChild(ph);
      return;
    }

    Object.entries(group).forEach(([subKey, chartData]) => {
      const labels = chartData?.labels ?? [];
      const dataSet = chartData?.data ?? [];
      const type = chartData?.type || style.defaultType;
      const horizontal = !!chartData?.horizontal || style.horizontal;

      if (!Array.isArray(labels) || labels.length === 0 || !Array.isArray(dataSet) || dataSet.length === 0) {
        const ph = document.createElement('div');
        ph.className = 'chart-container flex items-center justify-center';
        ph.style.minHeight = '160px';
        ph.innerHTML = `<div class="text-center"><div style="font-weight:600;margin-bottom:6px">${style.title}: ${subKey}</div><div style="color:#6b7280">Brak danych</div></div>`;
        container.appendChild(ph);
        return;
      }

      const height = computeHeight(labels, horizontal);
      const wrapper = document.createElement('div');
      wrapper.className = 'chart-container';
      wrapper.style.height = `${height}px`;
      container.appendChild(wrapper);

      const canvas = document.createElement('canvas');
      wrapper.appendChild(canvas);

      try {
        new Chart(canvas, {
          type,
          data: {
            labels,
            datasets: [{
              label: `${style.title}: ${subKey}`,
              data: dataSet,
              borderColor: style.color,
              backgroundColor: style.bg,
              fill: type === 'line',
              tension: type === 'line' ? 0.35 : 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: horizontal ? 24 : 8, right: 12, top: 12, bottom: 18 } },
            plugins: { legend: { display: true }, title: { display: true, text: `${style.title}: ${subKey}` } },
            indexAxis: horizontal ? 'y' : 'x'
          }
        });
      } catch (e) {
        const ph = document.createElement('div');
        ph.className = 'chart-container flex items-center justify-center';
        ph.style.minHeight = '160px';
        ph.innerHTML = `<div class="text-center"><div style="font-weight:600;margin-bottom:6px">Błąd renderu: ${style.title}: ${subKey}</div><div style="color:#ef4444">Sprawdź logi</div></div>`;
        container.appendChild(ph);
        console.error('Chart render error', sectionKey, subKey, e);
      }
    });
  });

  // Render basic tables: errors (summary + first 100 rows)
  try {
    const errorsSummary = data.summaries?.errors_summary || [];
    const errorsSection = document.querySelector('#errors');
    if (errorsSection) {
      const tbodyRows = errorsSummary.map(r => `<tr><td class="p-2">${r.Message || ''}</td><td class="p-2">${r.Count || 0}</td></tr>`).join('');
      const detailsRows = (data.tables.errors || []).slice(0, 100).map(row => `<tr><td class="p-2">${row.Timestamp || ''}</td><td class="p-2">${row.EventType || ''}</td><td class="p-2">${JSON.stringify(row.Details || {})}</td></tr>`).join('');
      const html = `
        <table class="w-full bg-white dark:bg-gray-800 rounded shadow mb-4 sortable">
          <thead><tr class="bg-gray-200 dark:bg-gray-700"><th class="p-2 table-header">Wiadomość</th><th class="p-2 table-header">Liczba</th></tr></thead>
          <tbody>${tbodyRows}</tbody>
        </table>
        <details class="mb-4"><summary class="cursor-pointer text-blue-600 dark:text-blue-400">Pokaż pełne dane błędów (pierwsze 100)</summary>
        <table class="w-full bg-white dark:bg-gray-800 rounded shadow sortable"><thead><tr class="bg-gray-200 dark:bg-gray-700"><th class="p-2 table-header">Timestamp</th><th class="p-2 table-header">Typ zdarzenia</th><th class="p-2 table-header">Szczegóły</th></tr></thead><tbody>${detailsRows}</tbody></table></details>
      `;
      errorsSection.innerHTML = html;
    }
  } catch (e) {
    console.error('Error rendering errors table', e);
  }

  // finished
  console.info('Client-side data load finished; tables sizes:', Object.fromEntries(Object.entries(data.tables).map(([k,v])=>[k, (v||[]).length])));
});

    </script>
</body>
</html>
